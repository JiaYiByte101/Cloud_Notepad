<!-- templates/sharing/view_shared_note.html -->
{% extends 'base.html' %}

{% block extra_css %}
<style>
    /* 添加不合规提示的特殊样式 */
    .alert-inappropriate {
        background: linear-gradient(135deg, #fff5f5, #ffe0e0, #ffd6d6) !important;
        border-left: 4px solid #dc3545 !important;
        color: #842029 !important;
    }
    .alert-inappropriate .alert-heading {
        color: #dc3545 !important;
        font-weight: 600;
    }
    .alert-inappropriate p {
        color: #842029 !important;
    }
    .alert-inappropriate .btn-close {
        color: #842029 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="mb-3">
        <a href="{% url 'sharing:public' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> 返回笔记广场
        </a>
    </div>

    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h1 class="card-title h2 mb-0">{{ notebook.title }}</h1>
            <div>
                {% if notebook.is_featured %}
                <span class="badge bg-warning text-dark me-2">
                    <i class="bi bi-star-fill"></i> 精选
                </span>
                {% endif %}
                <form method="post" action="{% url 'sharing:toggle_like' notebook.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-{% if user_liked %}danger{% else %}outline-danger{% endif %}">
                        <i class="bi bi-heart{% if user_liked %}-fill{% endif %}"></i>
                        {% if user_liked %}已点赞{% else %}点赞{% endif %} ({{ like_count }})
                    </button>
                </form>
            </div>
        </div>
        <div class="card-body">
            <div class="mb-3 text-muted small">
                <span>
                    <i class="bi bi-person"></i> {{ notebook.user.username }}
                </span>
                <span class="ms-3">
                    <i class="bi bi-calendar3"></i> {{ notebook.created_at|date:"Y-m-d H:i" }}
                </span>
                <!-- templates/sharing/view_shared_note.html 的剩余部分 -->
                <span class="ms-3">
                    <i class="bi bi-eye"></i> 阅读量（待实现）
                </span>
            </div>

            <!-- 笔记内容 -->
            <div class="content mb-4">
                {{ notebook.content|safe }}
            </div>

            <!-- 标签 -->
            {% if notebook.tags.all %}
            <div class="mb-3">
                {% for tag in notebook.tags.all %}
                <span class="badge bg-info text-dark">{{ tag.name }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 评论区 -->
    <div class="card">
        <div class="card-header">
            <h3 class="h5 mb-0">评论 ({{ comments.count }})</h3>
        </div>
        <div class="card-body">
            <!-- 动态提示区域 -->
            <div id="dynamic-alert-container"></div>
            
            <!-- 发表评论 -->
            <form method="post" id="comment-form" action="{% url 'sharing:view_note' notebook.id %}">
                {% csrf_token %}
                <input type="hidden" name="comment_id" id="comment-id-input">
                <div class="mb-3">
                    {{ comment_form.content }}
                    {% if comment_form.content.errors %}
                    <div class="invalid-feedback d-block">
                        {{ comment_form.content.errors }}
                    </div>
                    {% endif %}
                </div>
                <div class="text-end">
                    <button type="submit" class="btn btn-primary" id="submit-comment-btn">发表评论</button>
                    <button type="button" class="btn btn-secondary d-none" id="cancel-rewrite-btn">取消重写</button>
                </div>
            </form>

            <hr>

            <!-- 评论列表 -->
            {% if comments %}
                {% for comment in comments %}
                <div class="d-flex mb-3 comment-item {% if comment.status == 'INAPPROPRIATE' %}comment-inappropriate{% elif comment.status == 'PENDING' %}comment-pending{% endif %}" id="comment-{{ comment.id }}">
                    <div class="flex-shrink-0">
                        <!-- Assuming user profile and avatar exist, placeholder if not -->
                        {% if comment.user.profile.avatar.url %}
                        <img src="{{ comment.user.profile.avatar.url }}" alt="{{ comment.user.username }}"
                             class="rounded-circle" width="50" height="50">
                        {% else %}
                        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" 
                             style="width: 50px; height: 50px; font-size: 1.5rem;">
                             {{ comment.user.username|first|upper }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 d-inline">{{ comment.user.username }}</h6>
                                {% if comment.status == 'PENDING' and comment.user == request.user %}
                                <span class="badge bg-warning text-dark ms-2">待审核</span>
                                {% elif comment.status == 'INAPPROPRIATE' and comment.user == request.user %}
                                <span class="badge bg-danger ms-2" role="button" data-bs-toggle="tooltip" data-bs-placement="top" title="您的评论包含不当内容，请修改。">不合规</span>
                                {% endif %}
                            </div>
                            <small class="text-muted">{{ comment.created_at|date:"Y-m-d H:i" }}</small>
                        </div>
                        <p class="mb-1 comment-content">{{ comment.content|linebreaksbr }}</p>
                        
                        {% if comment.status == 'INAPPROPRIATE' and comment.user == request.user %}
                        <div class="mt-2 comment-actions">
                            <button class="btn btn-sm btn-outline-primary rewrite-comment-btn" data-comment-id="{{ comment.id }}" data-comment-content="{{ comment.content }}">重写</button>
                            <button class="btn btn-sm btn-outline-danger cancel-comment-btn" data-comment-id="{{ comment.id }}" data-url="{% url 'sharing:cancel_comment' comment.id %}">取消</button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% if not forloop.last %}<hr>{% endif %}
                {% endfor %}
            {% else %}
                <div class="text-center my-4 text-muted">
                    <p>暂无评论，成为第一个发表评论的人吧！</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 删除之前的不合规弹窗 Modal -->

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // 创建弹窗提示函数
    function showAlert(message, type = 'danger', extraClasses = '') {
        const alertContainer = document.getElementById('dynamic-alert-container');
        const alertHTML = `
            <div class="alert alert-${type} alert-dismissible fade show shadow-sm rounded-4 border-0 mb-3 ${extraClasses}" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        // 插入到顶部
        alertContainer.innerHTML = alertHTML + alertContainer.innerHTML;
        
        // 自动滚动到弹窗区域
        alertContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // 自动关闭提示（可选）
        const newAlert = alertContainer.querySelector('.alert:first-child');
        if (newAlert) {
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(newAlert);
                bsAlert.close();
            }, 10000); // 10秒后自动关闭
        }
    }

    // Tooltip initialization
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    const commentForm = document.getElementById('comment-form');
    const commentContentTextarea = commentForm.querySelector('textarea[name="content"]');
    const commentIdInput = document.getElementById('comment-id-input');
    const submitCommentBtn = document.getElementById('submit-comment-btn');
    const cancelRewriteBtn = document.getElementById('cancel-rewrite-btn');
    let currentRewritingCommentId = null;

    document.querySelectorAll('.rewrite-comment-btn').forEach(button => {
        button.addEventListener('click', function () {
            currentRewritingCommentId = this.dataset.commentId;
            const commentContent = this.dataset.commentContent;
            
            commentContentTextarea.value = commentContent;
            commentIdInput.value = currentRewritingCommentId; // Store comment_id for form submission
            submitCommentBtn.textContent = '保存修改';
            cancelRewriteBtn.classList.remove('d-none');
            commentContentTextarea.focus();
            
            // Scroll to form if needed
            commentForm.scrollIntoView({ behavior: 'smooth' });
        });
    });

    cancelRewriteBtn.addEventListener('click', function () {
        commentContentTextarea.value = '';
        commentIdInput.value = '';
        submitCommentBtn.textContent = '发表评论';
        cancelRewriteBtn.classList.add('d-none');
        currentRewritingCommentId = null;
    });

    // 不合规评论处理 - 使用基于 base.html 风格的提示但有特殊样式
    document.querySelectorAll('.comment-inappropriate .badge.bg-danger, .comment-inappropriate .comment-content').forEach(element => {
        element.addEventListener('click', function() {
            const commentItem = this.closest('.comment-item');
            currentRewritingCommentId = commentItem.id.split('-')[1];
            
            // 显示提示信息，添加特殊样式类
            showAlert(`
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0 text-danger">
                        <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                    </div>
                    <div class="ms-2 w-100">
                        <h5 class="alert-heading">评论内容不合规</h5>
                        <p class="mb-0">您的这条评论因为包含不恰当的内容，已被系统标记为不合规。请您修改评论内容后重新提交，或者选择取消发布。</p>
                        <div class="mt-2">
                            <button type="button" id="rewrite-from-alert-btn" class="btn btn-sm btn-danger" data-comment-id="${currentRewritingCommentId}">去重写</button>
                        </div>
                    </div>
                </div>
            `, 'danger', 'alert-inappropriate');
            
            // 添加重写按钮监听器
            document.getElementById('rewrite-from-alert-btn').addEventListener('click', function() {
                const rewriteButton = document.querySelector(`.rewrite-comment-btn[data-comment-id='${this.dataset.commentId}']`);
                if (rewriteButton) {
                    rewriteButton.click();
                }
                // 关闭提示
                const alertElement = this.closest('.alert');
                if (alertElement) {
                    const bsAlert = bootstrap.Alert.getInstance(alertElement);
                    if (bsAlert) bsAlert.close();
                }
            });
        });
    });

    document.querySelectorAll('.cancel-comment-btn').forEach(button => {
        button.addEventListener('click', function () {
            const commentId = this.dataset.commentId;
            const url = this.dataset.url; // Get URL from data attribute
            if (confirm('确定要取消并删除这条评论吗？此操作无法撤销。')) {
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById(`comment-${commentId}`).remove();
                        // 使用一致风格的提示
                        showAlert('评论已删除成功！', 'success');
                    } else {
                        showAlert('删除失败: ' + (data.error || '未知错误'), 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('操作失败，请稍后重试。', 'danger');
                });
            }
        });
    });
});
</script>
{% endblock %}